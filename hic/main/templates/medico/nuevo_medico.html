{% extends 'base.html' %}
{% load staticfiles %}

{% block custom_style %}
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.css">
    <link rel="stylesheet" href="{% static 'vendor/fullcalendar/packages/core/main.css' %}">
    <link rel="stylesheet" href="{% static 'vendor/fullcalendar/packages/daygrid/main.css' %}">
    <link rel="stylesheet" href="{% static 'vendor/fullcalendar/packages/timegrid/main.css' %}">
{% endblock %}

{% block head_js %}
    <script src="{% static 'vendor/fullcalendar/packages/core/main.js' %}"></script>
    <script src="{% static 'vendor/fullcalendar/packages/daygrid/main.js' %}"></script>
    <script src="{% static 'vendor/fullcalendar/packages/timegrid/main.js' %}"></script>
    <script src="{% static 'vendor/fullcalendar/packages/interaction/main.js' %}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            let calendarEl = document.getElementById('availability-calendar');
            let blockEvents = [];
            let calendar = new FullCalendar.Calendar(calendarEl, {
                plugins: ['interaction', 'dayGrid', 'timeGrid'],
                selectable: true,
                defaultView: 'timeGridWeek',
                header: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                select: function (info) {
                    let startTime = info.startStr;
                    let endTime = info.endStr;
                    let modal = document.getElementById("event-create");
                    sessionStorage.setItem('startTime', startTime);
                    sessionStorage.setItem('endTime', endTime);
                    modal.style.display = "block";
                    document.getElementById('start-time').innerHTML = new Date(startTime).toLocaleTimeString('es-MX');
                    document.getElementById('end-time').innerHTML = new Date(endTime).toLocaleTimeString('es-MX');
                    console.log(`Event time start ${startTime} end ${endTime}`);
                }
            });
            calendar.render();
            //Add event

            let btnAceptEvent = document.querySelector(".btn-acept-event");
            btnAceptEvent.onclick = function () {
                modal.style.display = "none";
                let actualStartTime = new Date(sessionStorage.getItem('startTime'));
                let actualEndTime = new Date(sessionStorage.getItem('endTime'));
                console.log(actualStartTime.toLocaleTimeString('es-MX'));
                //TODO validate if is allWeekDays
                if (actualStartTime && actualEndTime) { // valid?
                    calendar.addEvent({
                        title: 'No Consulta',
                        groupId: 'blockEvents',
                        allDay: false,
                        daysOfWeek: [0, 1, 2, 3, 4, 5, 6],
                        startTime: actualStartTime.toLocaleTimeString('es-MX'),
                        endTime: actualEndTime.toLocaleTimeString('es-MX'),
                        color: 'white'
                    });
                    let newEvent = {
                        title: 'No Consulta',
                        daysOfWeek: [0, 1, 2, 3, 4, 5, 6],
                        startTime: actualStartTime.toLocaleTimeString('es-MX'),
                        endTime: actualEndTime.toLocaleTimeString('es-MX'),
                        type: 'block'
                    };
                    blockEvents.push(newEvent);
                    sessionStorage.setItem('blockEvents', JSON.stringify(blockEvents));
                    alert('Great. Now, update your local array...');
                } else {
                    alert('Invalid date.');
                }
            };
        });
    </script>
{% endblock %}

{% block container %}
    {% include 'crear_evento.html' %}
    <div class="row">
        <div class="col">
            <div class="card shadow">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Nuevo Médico</h6>
                </div>
                <div class="card-body">
                    <form action="" method="post" name="doctor-form" id="doctor-form">
                        {% csrf_token %}
                        <div class="row">
                            <div class="col-12">
                                <h4>Datos Personales</h4>
                                <hr>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_nombre">Nombre</label>
                                    {{ form.nombre }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_primer_apellido">Primer Apellido</label>
                                    {{ form.primer_apellido }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_segundo_apellido">Segundo Apellido</label>
                                    {{ form.segundo_apellido }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_fecha">Fecha de Nacimiento</label>
                                    {{ form.fecha_nacimiento }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_genero">Género</label>
                                    {{ form.genero }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_telefono">Teléfono</label>
                                    {{ form.telefono }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h4>Datos Médicos</h4>
                                <hr>
                            </div>

                            <div class="col-12">
                                <div class="form-group">
                                    <label for="id_especialidades">Especialidades</label>
                                    {{ form.especialidades }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h4>Datos Consultorio</h4>
                                <hr>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_consultorio_nombre">Nombre Consultorio</label>
                                    {{ consultorio_form.nombre_consultorio }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_consultorio_telefono">Telefono</label>
                                    {{ consultorio_form.telefono }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_direccion_calle">Calle</label>
                                    {{ direccion_form.calle }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_direccion_numero_ext">No.Ext</label>
                                    {{ direccion_form.numero_ext }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_direccion_numero_int">No.Int</label>
                                    {{ direccion_form.numero_int }}
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_direccion_numero_codigo_postal">CP</label>
                                    {{ direccion_form.codigo_postal }}
                                </div>
                            </div>
                        </div>
                        <div class="row">

                            <div class="col-4">
                                <div class="form-group">
                                    <label for="id_direccion_colonia">Colonia</label>
                                    {{ direccion_form.colonia }}
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <h4>Datos Consulta</h4>
                                <hr>
                            </div>

                            <div class="col-12">
                                <p class="text-success">Seleccione las horas NO disponibles para consulta. Ej.: Horas de
                                    comida</p>
                            </div>
                            <div class="col-12">
                                <div id="availability-calendar"></div>
                            </div>
                        </div>
                        <div class="col-md-12">
                            <button class="btn btn-info btn-save-doctor">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

{% block custom_js %}
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-datetimepicker/2.5.20/jquery.datetimepicker.full.min.js"></script>

    <script>
        $(function () {

            $('select').select2()
            $('#id_fecha_nacimiento').datetimepicker({
                format: 'Y-m-d',
                step: 30
            });

            $('.btn-save-doctor').click(function (event) {
                event.preventDefault()
                let doctorForm = document.getElementById('doctor-form');
                let formData = new FormData(doctorForm);
                let blockEvents = sessionStorage.getItem('blockEvents');
                formData.append('calendar', JSON.stringify(blockEvents));
                axios.post("{% url 'main:nuevo_medico' %}", formData)
                        .then(function (response) {
                            console.log(response)
                        })
                        .catch(function (error) {
                            console.log(error);
                        });


            });

        })


    </script>
{% endblock %}